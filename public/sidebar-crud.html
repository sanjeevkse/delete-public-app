<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sidebar CRUD</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      h1,
      h2 {
        margin: 5px 0;
        font-size: 18px;
      }
      form {
        margin: 10px 0;
      }
      div {
        margin: 5px 0;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 3px;
      }
      form div input,
      form div select {
        width: 100%;
        max-width: 400px;
      }
      table {
        margin-top: 10px;
        width: 100%;
        border-collapse: collapse;
      }
      tr:nth-child(even) {
        background: #f9f9f9;
      }
      tr.inactive {
        background: #ffcccc;
      }
      .msg {
        padding: 5px;
        margin: 5px 0;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Sidebar CRUD</h1>

    <div id="alertBox"></div>

    <h2>Add/Edit</h2>
    <form id="sidebarForm">
      <div>
        <label>Display Name:</label>
      </div>
      <div>
        <input type="text" id="dispName" required />
      </div>
      <div>
        <label>Screen Name:</label>
      </div>
      <div>
        <input type="text" id="screenName" required readonly />
      </div>
      <div>
        <label>Icon:</label>
      </div>
      <div>
        <input type="text" id="icon" />
      </div>
      <div>
        <label>Status:</label>
      </div>
      <div>
        <select id="status">
          <option value="1">Active</option>
          <option value="0">Inactive</option>
        </select>
      </div>
      <div id="editInfo" class="hidden">Editing ID: <span id="editingId"></span></div>
      <div style="margin-top: 10px">
        <button type="submit">Save</button>
        <button type="button" id="cancelBtn" class="hidden">Cancel</button>
      </div>
    </form>

    <h2>Items</h2>
    <table border="1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Display Name</th>
          <th>Screen Name</th>
          <th>Icon</th>
          <th>Status</th>
          <th>Created</th>
          <th>Roles</th>
          <th>Permission Groups</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="9">Loading...</td>
        </tr>
      </tbody>
    </table>

    <h2>Manage Access</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
      <div>
        <label>Sidebar:</label>
        <select id="accessSidebarId">
          <option value="">Select sidebar</option>
        </select>
      </div>
      <div style="border-left: 1px solid #ccc; padding-left: 10px">
        <h3>Assign Roles</h3>
        <div>
          <label>Role:</label>
          <select id="roleId">
            <option value="">Select role</option>
          </select>
        </div>
        <button onclick="assignRole()">Assign Role</button>
        <div id="assignedRoles" style="margin-top: 10px; padding: 10px; background: #f0f0f0">
          Assigned roles will appear here
        </div>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px">
      <div style="border-right: 1px solid #ccc; padding-right: 10px">
        <h3>Assign Permission Groups</h3>
        <div>
          <label>Permission Group:</label>
          <select id="permissionGroupId">
            <option value="">Select group</option>
          </select>
        </div>
        <button onclick="assignPermissionGroup()">Assign Permission Group</button>
      </div>
      <div>
        <h3>Assigned Permission Groups</h3>
        <div
          id="assignedPermissionGroups"
          style="margin-top: 10px; padding: 10px; background: #f0f0f0"
        >
          Assigned permission groups will appear here
        </div>
      </div>
    </div>

    <script>
      const API_URL = "/api/auth/sidebar";
      const ROLE_API_URL = "/api/roles";
      const PERMISSION_GROUP_API_URL = "/api/permission-groups";

      function showAlert(msg, type) {
        const box = document.getElementById("alertBox");
        box.textContent = msg;
        box.className = `msg ${type}`;
        setTimeout(() => (box.className = ""), 3000);
      }

      async function loadRoles() {
        try {
          const res = await fetch(ROLE_API_URL);
          const data = await res.json();
          const roles = data.data || data || [];
          const select = document.getElementById("roleId");
          select.innerHTML =
            '<option value="">Select role</option>' +
            roles.map((r) => `<option value="${r.id}">${r.dispName}</option>`).join("");
        } catch (err) {
          console.error("Error loading roles:", err);
        }
      }

      async function loadPermissionGroups() {
        try {
          const res = await fetch(PERMISSION_GROUP_API_URL);
          const data = await res.json();
          const groups = data.data || data || [];
          const select = document.getElementById("permissionGroupId");
          select.innerHTML =
            '<option value="">Select group</option>' +
            groups.map((g) => `<option value="${g.id}">${g.label}</option>`).join("");
        } catch (err) {
          console.error("Error loading permission groups:", err);
        }
      }

      async function load() {
        try {
          const res = await fetch(`${API_URL}/sidebar`);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          const items = data.data || data || [];
          const tbody = document.getElementById("tableBody");
          const sidebarSelect = document.getElementById("accessSidebarId");

          if (!items.length) {
            tbody.innerHTML = '<tr><td colspan="9">No items</td></tr>';
            return;
          }

          tbody.innerHTML = items
            .map(
              (item) => `
                    <tr class="${item.status ? "" : "inactive"}">
                        <td>${item.id}</td>
                        <td>${item.dispName}</td>
                        <td>${item.screenName}</td>
                        <td>${item.icon || "-"}</td>
                        <td>${item.status ? "Active" : "Inactive"}</td>
                        <td>${new Date(item.createdAt).toLocaleDateString()}</td>
                        <td id="roles-${item.id}">Loading...</td>
                        <td id="groups-${item.id}">Loading...</td>
                        <td>
                            <button onclick="edit(${item.id}, '${item.dispName.replace(/'/g, "\\'")}', '${item.screenName.replace(/'/g, "\\'")}', '${(item.icon || "").replace(/'/g, "\\'")}', ${item.status})">Edit</button>
                        </td>
                    </tr>
                `
            )
            .join("");

          sidebarSelect.innerHTML =
            '<option value="">Select sidebar</option>' +
            items.map((item) => `<option value="${item.id}">${item.dispName}</option>`).join("");

          // Load role and permission group info for each sidebar
          items.forEach((item) => loadAccessInfo(item.id));
        } catch (err) {
          console.error(err);
          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan="9">Error loading: ${err.message}</td></tr>`;
        }
      }

      async function loadAccessInfo(sidebarId) {
        try {
          const res = await fetch(`${API_URL}/${sidebarId}`);
          const data = await res.json();
          const item = data.data;

          if (item.roles && Array.isArray(item.roles)) {
            document.getElementById(`roles-${sidebarId}`).innerHTML =
              item.roles
                .map(
                  (r) =>
                    `<span style="background:#e8f4f8; padding:2px 4px; margin:2px">${r.dispName}</span>`
                )
                .join("") || "No roles";
          } else {
            document.getElementById(`roles-${sidebarId}`).innerHTML = "No roles";
          }

          if (item.permissionGroupSidebars && Array.isArray(item.permissionGroupSidebars)) {
            document.getElementById(`groups-${sidebarId}`).innerHTML =
              item.permissionGroupSidebars
                .map(
                  (pg) =>
                    `<span style="background:#f0e8f4; padding:2px 4px; margin:2px">${pg.label || pg.permissionGroupId}</span>`
                )
                .join("") || "No groups";
          } else {
            document.getElementById(`groups-${sidebarId}`).innerHTML = "No groups";
          }
        } catch (err) {
          console.error("Error loading access info:", err);
        }
      }

      async function assignRole() {
        const sidebarId = document.getElementById("accessSidebarId").value;
        const roleId = document.getElementById("roleId").value;

        if (!sidebarId || !roleId) {
          showAlert("Select both sidebar and role", "error");
          return;
        }

        try {
          const res = await fetch(`${API_URL}/${sidebarId}/roles/${roleId}`, { method: "POST" });
          if (res.ok) {
            showAlert("Role assigned", "success");
            load();
          } else {
            const err = await res.json();
            showAlert(err.message || "Error", "error");
          }
        } catch (err) {
          showAlert("Error: " + err.message, "error");
        }
      }

      async function assignPermissionGroup() {
        const sidebarId = document.getElementById("accessSidebarId").value;
        const groupId = document.getElementById("permissionGroupId").value;

        if (!sidebarId || !groupId) {
          showAlert("Select both sidebar and permission group", "error");
          return;
        }

        try {
          const res = await fetch(`${API_URL}/${sidebarId}/permission-groups/${groupId}`, {
            method: "POST"
          });
          if (res.ok) {
            showAlert("Permission group assigned", "success");
            load();
          } else {
            const err = await res.json();
            showAlert(err.message || "Error", "error");
          }
        } catch (err) {
          showAlert("Error: " + err.message, "error");
        }
      }

      function edit(id, dispName, screenName, icon, status) {
        document.getElementById("dispName").value = dispName;
        document.getElementById("screenName").value = screenName;
        document.getElementById("icon").value = icon;
        document.getElementById("status").value = status;
        document.getElementById("editingId").textContent = id;
        document.getElementById("editInfo").classList.remove("hidden");
        document.getElementById("cancelBtn").classList.remove("hidden");
        document.getElementById("sidebarForm").dataset.id = id;
      }

      function reset() {
        document.getElementById("sidebarForm").reset();
        document.getElementById("sidebarForm").dataset.id = "";
        document.getElementById("editInfo").classList.add("hidden");
        document.getElementById("cancelBtn").classList.add("hidden");
      }

      document.getElementById("cancelBtn").addEventListener("click", reset);

      document.getElementById("sidebarForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const dispName = document.getElementById("dispName").value.trim();
        const screenName = document.getElementById("screenName").value.trim();
        const icon = document.getElementById("icon").value.trim() || null;
        const status = parseInt(document.getElementById("status").value);
        const id = document.getElementById("sidebarForm").dataset.id;

        if (!dispName || !screenName) {
          showAlert("Fill required fields", "error");
          return;
        }

        try {
          const url = id ? `${API_URL}/${id}` : API_URL;
          const res = await fetch(url, {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dispName, screenName, icon, status })
          });

          if (res.ok) {
            showAlert(id ? "Updated" : "Created", "success");
            reset();
            load();
          } else {
            const err = await res.json();
            showAlert(err.message || "Error", "error");
          }
        } catch (err) {
          showAlert("Error: " + err.message, "error");
        }
      });

      loadRoles();
      loadPermissionGroups();
      load();
    </script>
  </body>
</html>
