<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sidebar CRUD</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
        margin: 0;
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 20px;
      }
      h2 {
        margin: 5px 0 10px 0;
        font-size: 14px;
      }
      .container {
        display: grid;
        grid-template-columns: 450px 1fr;
        gap: 15px;
        height: calc(100vh - 80px);
      }
      form {
        overflow-y: auto;
        padding-right: 10px;
      }
      .form-group {
        margin: 6px 0;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 2px;
        font-size: 13px;
      }
      input,
      select {
        width: 100%;
        padding: 4px;
        font-size: 13px;
        box-sizing: border-box;
      }
      #rolesCheckboxes,
      #permissionGroupsCheckboxes {
        border: 1px solid #ccc;
        padding: 6px;
        max-height: 80px;
        overflow-y: auto;
        margin-bottom: 6px;
        font-size: 12px;
      }
      #rolesCheckboxes div,
      #permissionGroupsCheckboxes div {
        margin: 2px 0;
        display: flex;
        align-items: center;
      }
      #rolesCheckboxes input,
      #permissionGroupsCheckboxes input {
        margin-right: 4px;
        width: auto;
      }
      #rolesCheckboxes label,
      #permissionGroupsCheckboxes label {
        margin: 0;
        font-weight: normal;
        font-size: 12px;
        display: inline;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        overflow: auto;
      }
      th, td {
        padding: 4px;
        text-align: left;
        border: 1px solid #ddd;
      }
      th {
        background: #f5f5f5;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background: #f9f9f9;
      }
      tr.inactive {
        background: #ffcccc;
      }
      button {
        padding: 4px 8px;
        margin: 3px 3px 3px 0;
        font-size: 12px;
        cursor: pointer;
      }
      #alertBox {
        padding: 5px;
        margin: 5px 0;
        border-radius: 3px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Sidebar CRUD</h1>
    <div id="alertBox"></div>

    <div class="container">
      <div>
        <h2>Add/Edit</h2>
        <form id="sidebarForm">
          <div class="form-group">
            <label>Display Name:</label>
            <input type="text" id="dispName" required />
          </div>
          <div class="form-group">
            <label>Screen Name:</label>
            <input type="text" id="screenName" required readonly />
          </div>
          <div class="form-group">
            <label>Icon:</label>
            <input type="text" id="icon" />
          </div>
          <div class="form-group">
            <label>Status:</label>
            <select id="status">
              <option value="1">Active</option>
              <option value="0">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Roles:</label>
            <div id="rolesCheckboxes">Loading roles...</div>
          </div>
          <div class="form-group">
            <label>Permission Groups:</label>
            <div id="permissionGroupsCheckboxes">Loading permission groups...</div>
          </div>
          <div id="editInfo" class="hidden">Editing ID: <span id="editingId"></span></div>
          <div>
            <button type="submit">Save</button>
            <button type="button" id="cancelBtn" class="hidden">Cancel</button>
          </div>
        </form>
      </div>

      <div>
        <h2>Items</h2>
        <table border="1">
          <thead>
            <tr>
              <th>ID</th>
              <th>Display Name</th>
              <th>Screen Name</th>
              <th>Icon</th>
              <th>Status</th>
              <th>Created</th>
              <th>Roles</th>
              <th>Permission Groups</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="9">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      const API_URL = "/api/sidebar-view";
      const ROLES_API = "/api/sidebar-view/lookup/roles";
      const PERMISSION_GROUPS_API = "/api/sidebar-view/lookup/permission-groups";

      function showAlert(msg, type) {
        const box = document.getElementById("alertBox");
        box.textContent = msg;
        box.className = `msg ${type}`;
        setTimeout(() => (box.className = ""), 3000);
      }

      async function loadRoles() {
        try {
          const res = await fetch(ROLES_API);
          const data = await res.json();
          const roles = data.data || data || [];
          const container = document.getElementById("rolesCheckboxes");
          if (!roles.length) {
            container.innerHTML = "No roles available";
            return;
          }
          container.innerHTML = roles.map((r) => `
            <div>
              <input type="checkbox" id="role_${r.id}" value="${r.id}" class="roleCheckbox">
              <label for="role_${r.id}">${r.dispName}</label>
            </div>
          `).join("");
        } catch (err) {
          console.error("Error loading roles:", err);
          document.getElementById("rolesCheckboxes").innerHTML = "Error loading roles";
        }
      }

      async function loadPermissionGroups() {
        try {
          const res = await fetch(PERMISSION_GROUPS_API);
          const data = await res.json();
          const groups = data.data || data || [];
          const container = document.getElementById("permissionGroupsCheckboxes");
          if (!groups.length) {
            container.innerHTML = "No permission groups available";
            return;
          }
          container.innerHTML = groups.map((g) => `
            <div>
              <input type="checkbox" id="pg_${g.id}" value="${g.id}" class="pgCheckbox">
              <label for="pg_${g.id}">${g.label}</label>
            </div>
          `).join("");
        } catch (err) {
          console.error("Error loading permission groups:", err);
          document.getElementById("permissionGroupsCheckboxes").innerHTML = "Error loading permission groups";
        }
      }

      async function load() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          console.log("Data:", data);
          const items = data.data || data || [];
          const tbody = document.getElementById("tableBody");

          if (!items.length) {
            tbody.innerHTML = '<tr><td colspan="9">No items</td></tr>';
            return;
          }

          tbody.innerHTML = items
            .map(
              (item) => `
                    <tr class="${item.status ? "" : "inactive"}">
                        <td>${item.id}</td>
                        <td>${item.dispName}</td>
                        <td>${item.screenName}</td>
                        <td>${item.icon || "-"}</td>
                        <td>${item.status ? "Active" : "Inactive"}</td>
                        <td>${new Date(item.createdAt).toLocaleDateString()}</td>
                        <td>${item.roles && item.roles.length ? item.roles.map((r) => r.dispName).join(", ") : "-"}</td>
                        <td>${item.permissionGroups_assigned && item.permissionGroups_assigned.length ? item.permissionGroups_assigned.map((p) => p.label).join(", ") : "-"}</td>
                        <td>
                            <button onclick="edit(${item.id})">Edit</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (err) {
          console.error(err);
          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan="9">Error loading: ${err.message}</td></tr>`;
        }
      }

      function edit(id) {
        fetch(`${API_URL}/${id}`)
          .then((res) => res.json())
          .then((data) => {
            const item = data.data;
            document.getElementById("dispName").value = item.dispName;
            document.getElementById("screenName").value = item.screenName;
            document.getElementById("icon").value = item.icon || "";
            document.getElementById("status").value = item.status;
            
            // Uncheck all first
            document.querySelectorAll(".roleCheckbox").forEach((cb) => (cb.checked = false));
            document.querySelectorAll(".pgCheckbox").forEach((cb) => (cb.checked = false));
            
            // Check assigned roles
            if (item.roles && item.roles.length) {
              item.roles.forEach((r) => {
                const cb = document.getElementById(`role_${r.id}`);
                if (cb) cb.checked = true;
              });
            }
            
            // Check assigned permission groups
            if (item.permissionGroups_assigned && item.permissionGroups_assigned.length) {
              item.permissionGroups_assigned.forEach((p) => {
                const cb = document.getElementById(`pg_${p.id}`);
                if (cb) cb.checked = true;
              });
            }
            
            document.getElementById("editingId").textContent = id;
            document.getElementById("editInfo").classList.remove("hidden");
            document.getElementById("cancelBtn").classList.remove("hidden");
            document.getElementById("sidebarForm").dataset.id = id;
          })
          .catch((err) => console.error("Error loading sidebar:", err));
      }

      function reset() {
        document.getElementById("sidebarForm").reset();
        document.getElementById("sidebarForm").dataset.id = "";
        document.getElementById("editInfo").classList.add("hidden");
        document.getElementById("cancelBtn").classList.add("hidden");
      }

      document.getElementById("cancelBtn").addEventListener("click", reset);

      document.getElementById("sidebarForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const dispName = document.getElementById("dispName").value.trim();
        const screenName = document.getElementById("screenName").value.trim();
        const icon = document.getElementById("icon").value.trim() || null;
        const status = parseInt(document.getElementById("status").value);
        const id = document.getElementById("sidebarForm").dataset.id;

        const selectedRoles = Array.from(document.querySelectorAll(".roleCheckbox:checked")).map(
          (cb) => cb.value
        );
        const selectedPGs = Array.from(document.querySelectorAll(".pgCheckbox:checked")).map(
          (cb) => cb.value
        );

        if (!dispName || !screenName) {
          showAlert("Fill required fields", "error");
          return;
        }

        try {
          const url = id ? `${API_URL}/${id}` : API_URL;
          const res = await fetch(url, {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dispName, screenName, icon, status })
          });

          if (res.ok) {
            const newItem = await res.json();
            const sidebarId = id || newItem.data.id;

            for (const roleId of selectedRoles) {
              try {
                const roleRes = await fetch(`/api/sidebar-view/${sidebarId}/roles/${roleId}`, {
                  method: "POST"
                });
                if (!roleRes.ok) console.error("Role assignment failed:", roleRes.status);
              } catch (err) {
                console.error("Role assignment error:", err);
              }
            }

            for (const pgId of selectedPGs) {
              try {
                const pgRes = await fetch(
                  `/api/sidebar-view/${sidebarId}/permission-groups/${pgId}`,
                  { method: "POST" }
                );
                if (!pgRes.ok) console.error("Permission group assignment failed:", pgRes.status);
              } catch (err) {
                console.error("Permission group assignment error:", err);
              }
            }

            showAlert(id ? "Updated" : "Created", "success");
            reset();
            load();
          } else {
            const err = await res.json();
            showAlert(err.message || "Error", "error");
          }
        } catch (err) {
          showAlert("Error: " + err.message, "error");
        }
      });

      loadRoles();
      loadPermissionGroups();
      load();
    </script>
  </body>
</html>
