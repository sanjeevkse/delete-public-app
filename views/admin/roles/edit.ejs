<%- include('../../layout', { title: 'Edit Role', currentPage: 'roles', body: `
<div class="page-header">
  <h1><i class="fas fa-user-tie"></i> Edit Role</h1>
  <p>Update role details and permissions</p>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Role Details</h5>
      </div>
      <div class="card-body">
        <form id="roleForm">
          <div class="mb-3">
            <label class="form-label">Role Name</label>
            <input type="text" class="form-control" id="roleName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="roleDescription" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Assigned Permissions</h5>
      </div>
      <div class="card-body">
        <div id="permissionsListContainer">
          <div class="text-center">
            <div class="loading"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const roleId = '<%= roleId %>';

  async function loadRole() {
    try {
      const data = await fetchAPI(API_BASE + '/roles/' + roleId);
      const role = data.data || data;

      document.getElementById('roleName').value = role.dispName || '';
      document.getElementById('roleDescription').value = role.description || '';
    } catch (error) {
      showAlert('Error loading role', 'danger');
    }
  }

  async function loadPermissions() {
    try {
      const data = await fetchAPI(API_BASE + '/roles/' + roleId + '/permissions');
      const permissions = data.data || [];

      let html = '<div class="list-group">';
      permissions.forEach(perm => {
        html += '<div class="list-group-item">';
        html += '<code>' + perm.dispName + '</code>';
        if (perm.description) {
          html += '<br><small class="text-muted">' + perm.description + '</small>';
        }
        html += '</div>';
      });
      html += '</div>';

      if (permissions.length === 0) {
        html = '<p class="text-muted">No permissions assigned</p>';
      }

      document.getElementById('permissionsListContainer').innerHTML = html;
    } catch (error) {
      document.getElementById('permissionsListContainer').innerHTML = '<p class="text-danger">Error loading permissions</p>';
    }
  }

  document.getElementById('roleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      await fetchAPI(API_BASE + '/roles/' + roleId, {
        method: 'PUT',
        body: JSON.stringify({
          dispName: document.getElementById('roleName').value,
          description: document.getElementById('roleDescription').value
        })
      });
      showAlert('Role updated successfully', 'success');
    } catch (error) {
      console.error('Error:', error);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadRole();
    loadPermissions();
  });
</script>
` }) %>
